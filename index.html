<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Intercom v21 - Auto-Extend TV</title>
    <style>
        :root {
            --bg-main: #FFFFFF; 
            --text-main: #000000;
            --accent: #ccff00;
            --btn-op: #1a1a1a;
            --danger: #ff0000;
            --proceed: #0055ff;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f8f9fa; touch-action: manipulation; overflow: hidden; }
        .admin-header { padding: 15px; background: #fff; border-bottom: 2px solid #ddd; }
        #button-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; padding: 20px; }
        
        .state-container { 
            display: none; height: 100vh; width: 100vw; 
            flex-direction: column; align-items: center; justify-content: center; 
            background: var(--bg-main); color: var(--text-main); 
            position: fixed; top: 0; left: 0; z-index: 2000; 
        }
        .active { display: flex !important; }

        .bell-btn { font-size: 200px; cursor: pointer; background: none; border: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .script-box { 
            background: #fff; padding: 50px; border-radius: 30px; 
            border: 10px solid #000; width: 90%; font-size: 48px; font-weight: 700;
            text-align: center; color: #000; line-height: 1.3;
            box-shadow: 15px 15px 0px #ccff00; box-sizing: border-box;
        }
        .script-box b { color: #0055ff; text-decoration: underline; }

        .meter-container { width: 80%; height: 50px; background: #eee; border-radius: 25px; margin-top: 40px; overflow: hidden; border: 5px solid #000; }
        #volumeBar { width: 0%; height: 100%; background: #00cc00; transition: width 0.1s; }

        #proceedBtn {
            display: none; background: var(--proceed); color: white; border: 5px solid #000; padding: 30px 80px;
            font-size: 2.5rem; font-weight: bold; border-radius: 25px; cursor: pointer; margin-top: 30px;
        }

        .op-list { width: 100%; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 40px; box-sizing: border-box; flex-grow: 1; overflow-y: auto; }
        .op-btn { 
            background: var(--btn-op); color: var(--accent); border: 5px solid #000; padding: 40px; 
            font-size: 2.5rem; font-weight: bold; border-radius: 25px; cursor: pointer; text-align: center;
        }

        .manual-reset { 
            background: var(--danger); color: white; border: 4px solid #000; padding: 20px 50px; 
            font-size: 1.6rem; font-weight: bold; border-radius: 15px; cursor: pointer; 
            margin-top: auto; margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="admin-header" id="adminPanel">
        <input type="text" id="nameInput" placeholder="Teacher Name..." style="padding:10px;">
        <button onclick="addTeacher()" style="background:green; color:#fff; padding:10px;">ADD</button>
        <button onclick="openTV()" style="background:blue; color:#fff; padding:10px;">1. OPEN TV ON EXTENDED</button>
        <button onclick="startOperator()" style="background:black; color:#fff; padding:10px;">2. START SYSTEM</button>
        <div id="button-grid"></div>
    </div>

    <div id="state-1" class="state-container">
        <button class="bell-btn" onclick="triggerDoorbell()">ðŸ””</button>
        <h1 style="color:#000; font-size: 5rem; margin-top:20px; font-weight: 900;">TAP TO START</h1>
    </div>

    <div id="state-2" class="state-container">
        <div class="script-box">
            "Good morning/afternoon po!<br>
            I'm <b>(your name)</b>, from <b>(grade & section)</b>.<br><br>
            <b>(State your purpose)</b>"
        </div>
        <div class="meter-container"><div id="volumeBar"></div></div>
        <button id="proceedBtn" onclick="finalizeIntercom()">DONE TALKING â†’</button>
        <p id="micStatus" style="color:#000; margin-top:20px; font-weight:900; font-size: 2rem;">SPEAK LOUDLY</p>
        <button class="manual-reset" onclick="cancelIntercom()">RESET SYSTEM</button>
    </div>

    <div id="state-3" class="state-container">
        <h2 style="color:#000; font-size: 4rem; margin-top: 40px; font-weight: 900;">Choose Teacher:</h2>
        <div id="op-list-container" class="op-list"></div>
        <button class="manual-reset" onclick="cancelIntercom()">RESET SYSTEM</button>
    </div>

    <audio id="sndDoorbell" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" preload="auto"></audio>
    <audio id="sndChime" src="https://assets.mixkit.co/active_storage/sfx/2864/2864-preview.mp3" preload="auto"></audio>

<script>
    let tvWindow = null;
    let teachers = JSON.parse(localStorage.getItem('teachers')) || ["Teacher 1"];
    let recognition;
    let localStream;
    let audioContext, analyser, dataArray, animationId;
    let hasStartedTalking = false;
    let state3IdleTimer;
    let isLocked = false;

    // --- FULL SCREEN LOCK ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(() => {});
        }
    }

    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && isLocked) {
            cancelIntercom();
        }
    });

    function setUI(state) {
        document.querySelectorAll('.state-container').forEach(c => c.classList.remove('active'));
        if(state > 0) {
            document.getElementById(`state-${state}`).classList.add('active');
            isLocked = true;
            toggleFullScreen();
        } else {
            isLocked = false;
        }
        if(tvWindow) tvWindow.postMessage({type: 'SYNC_STATE', state: state}, '*');
        clearTimeout(state3IdleTimer);
        if(state === 3) state3IdleTimer = setTimeout(() => cancelIntercom(), 60000);
    }

    function startOperator() {
        if(!tvWindow || tvWindow.closed) return alert("Please open TV Window first!");
        setUI(1);
    }

    function triggerDoorbell() {
        if(tvWindow) tvWindow.postMessage({type: 'RESET_TV'}, '*');
        document.getElementById('sndDoorbell').play().catch(() => {});
        setTimeout(() => { setUI(2); startVoiceAndCam(); }, 1200);
    }

    async function startVoiceAndCam() {
        hasStartedTalking = false;
        document.getElementById('proceedBtn').style.display = 'none';
        try {
            const constraints = { video: true, audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: true } };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            if(tvWindow) tvWindow.postMessage({type: 'START_VIDEO'}, '*');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(localStream);
            const enhancer = audioContext.createGain();
            enhancer.gain.value = 2.5;
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(enhancer);
            enhancer.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVolume();

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.onresult = () => {
                    hasStartedTalking = true;
                    document.getElementById('proceedBtn').style.display = 'block';
                    clearTimeout(window.silenceTimer);
                    window.silenceTimer = setTimeout(() => cancelIntercom(), 10000); 
                };
                recognition.start();
            }
        } catch (err) { console.error(err); }
    }

    function drawVolume() {
        animationId = requestAnimationFrame(drawVolume);
        analyser.getByteFrequencyData(dataArray);
        let values = 0;
        for (let i = 0; i < dataArray.length; i++) values += dataArray[i];
        let average = values / dataArray.length;
        document.getElementById('volumeBar').style.width = Math.min(average * 2.5, 100) + "%";
    }

    function cancelIntercom() {
        cancelAnimationFrame(animationId);
        if(recognition) { try{recognition.stop();}catch(e){} recognition.onend = null; }
        if(audioContext) audioContext.close();
        clearTimeout(window.silenceTimer);
        clearTimeout(state3IdleTimer);
        stopAllStreams();
        setUI(1);
    }

    function finalizeIntercom() {
        cancelAnimationFrame(animationId);
        if(recognition) { try{recognition.stop();}catch(e){} recognition.onend = null; }
        if(audioContext) audioContext.close();
        clearTimeout(window.silenceTimer);
        stopAllStreams();
        setUI(3);
        renderOpList();
    }

    function stopAllStreams() {
        if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
        if(tvWindow) tvWindow.postMessage({type: 'STOP_VIDEO'}, '*');
    }

    function renderOpList() {
        const container = document.getElementById('op-list-container');
        container.innerHTML = '';
        teachers.forEach(name => {
            const b = document.createElement('div');
            b.className = 'op-btn';
            b.innerText = name;
            b.onclick = () => {
                document.getElementById('sndChime').play();
                if(tvWindow) tvWindow.postMessage({type: 'SHOW_NAME', name: name}, '*');
                cancelIntercom();
            };
            container.appendChild(b);
        });
    }

    // --- UPDATED: AUTO-DETECTION FOR EXTENDED SCREEN ---
    async function openTV() {
        let left = 0;
        let width = 1200;
        let height = 800;

        try {
            if ('getScreenDetails' in window || 'getDisplayMedia' in navigator) {
                const screenDetails = await window.getScreenDetails();
                // Check if there's more than one screen
                if (screenDetails.screens.length > 1) {
                    const extendedScreen = screenDetails.screens[1]; // Target second screen
                    left = extendedScreen.availLeft;
                    width = extendedScreen.availWidth;
                    height = extendedScreen.availHeight;
                }
            }
        } catch (e) {
            console.log("Using default window position. Allow window-management for auto-detect.");
        }

        const features = `width=${width},height=${height},left=${left},top=0,menubar=no,toolbar=no,location=no,status=no`;
        tvWindow = window.open("", "TVDisplay", features);
        tvWindow.document.write(`
            <html><body style="background:#000; color:#fff; margin:0; overflow:hidden; display:flex; align-items:center; justify-content:center; height:100vh; font-family:sans-serif;">
                <div id="main" style="text-align:center; width:100%;">
                    <h1 id="msg" style="font-size:8vw;">WELCOME</h1>
                </div>
                <video id="v" style="display:none; width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; transform: scaleX(-1);" autoplay playsinline></video>
                <script>
                    let tvStream;
                    let resetTimer;
                    window.onmessage = (e) => {
                        const m = document.getElementById('msg');
                        const v = document.getElementById('v');
                        const main = document.getElementById('main');
                        if(e.data.type === 'SYNC_STATE' && e.data.state === 1 && !resetTimer) { 
                            main.style.display = 'block'; v.style.display = 'none'; 
                            main.innerHTML = '<h1 style="font-size:8vw;">WELCOME</h1>';
                        }
                        if(e.data.type === 'RESET_TV') {
                            clearTimeout(resetTimer); resetTimer = null;
                            main.style.display = 'block'; v.style.display = 'none'; 
                            main.innerHTML = '<h1 style="font-size:8vw;">WELCOME</h1>';
                        }
                        if(e.data.type === 'START_VIDEO') {
                            clearTimeout(resetTimer); resetTimer = null;
                            main.style.display = 'none'; v.style.display = 'block';
                            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => { tvStream = s; v.srcObject = s; });
                        }
                        if(e.data.type === 'STOP_VIDEO') {
                            if(tvStream) tvStream.getTracks().forEach(t => t.stop());
                            v.style.display = 'none';
                        }
                        if(e.data.type === 'SHOW_NAME') {
                            v.style.display = 'none'; main.style.display = 'block';
                            main.innerHTML = '<div style="border:15px solid #ccff00; border-radius:50px; padding:40px; display:inline-block;"><h1 style="font-size:12vw; color:#ccff00; margin:0;">' + e.data.name + '</h1></div>';
                            clearTimeout(resetTimer);
                            resetTimer = setTimeout(() => {
                                main.innerHTML = '<h1 style="font-size:8vw;">WELCOME</h1>';
                                resetTimer = null;
                            }, 30000);
                        }
                    }
                <\/script>
            </body></html>
        `);
    }

    function addTeacher() {
        const n = document.getElementById('nameInput').value;
        if(n) { teachers.push(n); teachers.sort(); localStorage.setItem('teachers', JSON.stringify(teachers)); renderAdmin(); document.getElementById('nameInput').value=''; }
    }
    function deleteTeacher(name) { teachers = teachers.filter(t => t !== name); localStorage.setItem('teachers', JSON.stringify(teachers)); renderAdmin(); }
    function renderAdmin() {
        const grid = document.getElementById('button-grid');
        grid.innerHTML = '';
        teachers.forEach(t => {
            grid.innerHTML += '<div style="background:#fff; padding:10px; border:1px solid #000; display:flex; justify-content:space-between; margin:2px;"><span>'+t+'</span> <button onclick="deleteTeacher(\''+t+'\')" class="delete-btn">X</button></div>';
        });
    }
    renderAdmin();
</script>
</body>
</html>
